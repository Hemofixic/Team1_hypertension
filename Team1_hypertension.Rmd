---
title: "Гипертензия в Доминиканской республике"
author: "Команда №1: Ахметова Мария, Ильина Ирина, Кулиева Мария, Левченко Диана"
date: "2025-11-02"
output:
  html_document:
    toc: true
    toc_float: 
      collapsed: false
    toc_depth: 2
    toc-title: "Содержание"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)

library(flextable)
library(tidyverse)
library(readxl)
library(scales)
library(patchwork)
library(knitr)
library(exactRankTests)
library(DescTools)

no_legend <- theme(
    legend.position= "none"
  )
no_y <- labs(
  y = ""
)

gender_fill <- scale_fill_manual(name= "Пол",
                   labels = c("Female" = "Женский", "Male" = "Мужской"),
                   values=c(
                    "Male" = "#1b909a",
                    "Female" = "#eb4729")
)
gender_col <- scale_colour_manual(name= "Пол",
                   labels = c("Female" = "Женский", "Male" = "Мужской"),
                   values=c(
                    "Male" = "#1b909a",
                    "Female" = "#eb4729")
)
theme_set(theme_bw())
axis_theme <- theme(
    plot.title = element_text(size=20, hjust=0.5),
    plot.subtitle = element_text(size=14, hjust=0.5),
    axis.title = element_text(size=16),
    axis.text.y = element_text(size=12),
    axis.text.x = element_text(size=12),
    legend.title = element_text(size = 16),
    legend.text = element_text(size = 14),
    )
```

# 1. Загрузка данных и разделение пациентов на три группы в зависимости от тяжести гипертензии

```{r hypertension-classification}
hypertension <- read_xlsx("data/originals/DominicanHTN_add_sign.xlsx")
hypertension <- hypertension %>%
  mutate(severity_hypertension = case_when(
    (SBP < 140 & DBP < 90) ~ "norm",
    ((SBP >= 140 & SBP < 160) | (DBP >= 90 & DBP < 100)) ~ "stage1", 
    ((SBP >= 160 & SBP < 180) | (DBP >= 100 & DBP < 110)) ~ "stage2", 
    (SBP >= 180 | DBP >= 110) ~ "stage3", 
    TRUE ~ "crisis" ))  %>% 
  mutate(Severity_hypertension_category = case_when(
    (severity_hypertension == "norm") ~ 0,
    (severity_hypertension == "stage1") ~ 1,
    (severity_hypertension == "stage2") ~ 2,
    (severity_hypertension == "stage3") ~ 3
  ))

hypertension %>% 
  filter(severity_hypertension == "crisis") #все пациенты распределены по группам
```

# 2. Визуализация распределения значений признаков средствами ggplot2 и сопутствующих пакетов.

Проанализируем исходные данные. 

Датасет состоит из 5 признаков:

- деревня (один из 8 вариантов)
- пол (мужской или женский)
- возраст (целое число)
- систолическое давление (целое число)
- диастолическое давление (целое число)

Пропущенных значений нет.

В представленном датасете женщин примерно в 2 раза больше, чем мужчин:

```{r gender_counts, echo=FALSE}

gender_table <- hypertension %>%
  mutate(Пол = case_when(
    Gender == "Male" ~ "Мужской",
    Gender == "Female" ~ "Женский"
  )) %>%
  count(Пол) %>%
  rename("Количество" = n) %>%
  bind_rows(
    tibble(Пол = "Всего", Количество = sum(.$Количество))
  ) 
qflextable(gender_table) %>% set_caption("Распределение пациентов по полу")

```

```{r median_age, include=FALSE}
hypertension %>% group_by(Gender) %>% summarise(median_age=median(Age))
```

Количественные признаки распределены неравномерно, их распределение у женщин и мужчин отличается. Особенно заметна разница в возрасте - для женщин медианный возраст составляет 43 года, для мужчин - 53.


```{r, fig.height=7, fig.width=10, fig.align='center', echo=FALSE}
p1 <- ggplot(hypertension, aes(x = SBP, fill = Gender)) + 
  geom_density(alpha = 0.5) + no_legend + labs(x = "ДАД") + scale_x_continuous(breaks = seq(80, 350, 20))
p2 <- ggplot(hypertension, aes(x = DBP, fill = Gender)) + 
  geom_density(alpha = 0.5) + no_legend + labs(x = "САД") + scale_x_continuous(breaks = seq(20, 350, 20))
p3 <- ggplot(hypertension, aes(x = Age, fill = Gender)) + 
  geom_density(alpha = 0.5) + labs(x = "Возраст") + scale_x_continuous(breaks=seq(0, 100, 10))


(p2 + p1) / p3 + plot_annotation(title = "Распределение количественных признаков у мужчин и женщин") + plot_layout(guides = "collect") & no_y & gender_fill & axis_theme
```

Визуализируем зависимость систолического артериального давления (САД) и диастолического артериального давления (ДАД) от возраста для разных полов. ДАД имеет меньшие значения, меньший разброс и меньше зависит от возраста. 


```{r bp_age, fig.width=10 , echo=FALSE}
p1 <- ggplot(hypertension, aes(x=Age, y=SBP, color=Gender))+
  geom_point() + labs(x = "Возраст", y="САД") + scale_y_continuous(breaks = seq(20, 350, 20))
p2 <- ggplot(hypertension, aes(x=Age, y=DBP, color=Gender))+
  geom_point() + labs(x = "Возраст", y="ДАД") + scale_y_continuous(breaks = seq(20, 350, 20))
p1 + p2 + plot_layout(guides = "collect") + plot_annotation(title = "Зависимость САД и ДАД от возраста для мужчин и женщин") & gender_col & axis_theme & theme(legend.position = "bottom") 
```

Деревни отличаются по населению и гендерному соотношению - в деревнях от 32 до 64 человек, из них женщин - от 60% до 80%.


```{r villages, fig.width=11, fig.height=4, echo=FALSE}
ggplot(hypertension) +
  geom_bar(aes(x = fct_infreq(Village), fill = Gender), alpha=0.8) + gender_fill +
  labs(x="", y="Число жителей",title="Число жителей и гендерный состав населенных пунктов")+axis_theme
```

```{r villages2, fig.width=12, fig.height=4, include=FALSE}
village_stats <- hypertension %>%
  group_by(Village) %>%
  summarise(
    total = n(),
    pct_female = mean(Gender == "Female") * 100
  )
ggplot(village_stats, aes(x = fct_reorder(Village, total, .desc = T), y = total, fill = pct_female)) +
  geom_col() +
  scale_fill_gradient(low = "#1b909a", high = "#eb4729", name = "% женщин") +
  labs(x = "", y = "Число жителей", title="Число жителей и гендерный состав населенных пунктов") + axis_theme
```

```{r villages3, fig.width=12, fig.height=4, include=FALSE}
ggplot(village_stats, aes(x = fct_reorder(Village, total, .desc = T), y = total, fill = pct_female)) +
  geom_col() +
  scale_fill_gradient(low = "#9BCD9B", high = "darkolivegreen", name = "% женщин") +
  labs(x = "", y = "Число жителей", title="Число жителей и гендерный состав населенных пунктов") + axis_theme
```

# 3. Подобор и реализация средств для визуальной оценки взаимосвязи между группой по гипертензии и собранными признаками пациентов.

## Распределение возраста по группам в зависимости от выраженности гипертензии

Построим график распределения возраста пациентов в зависимости от выраженности гипертензии в группах.

```{r, fig.width=11, fig.height=6}
scale_x_hypertension <- scale_x_discrete(name = "Группа",
                                         labels = c("norm" = "Здоровые пациенты",
                                                    "stage1" = "Гипертензия 1 степени",
                                                    "stage2" = "Гипертензия 2 степени",
                                                    "stage3" = "Гипертензия 3 степени"))

ggplot(hypertension, aes(x = severity_hypertension, y = Age)) +
  geom_boxplot(width = 0.8, alpha = 0.6, fill = "aquamarine3") +
  geom_jitter(width = 0.3, alpha = 0.4, color = "black") +
  labs(title = "Распределение возраста пациентов в зависимости от выраженности гипертензии", 
       x = "Группа", 
       y = "Возраст, лет")+
  scale_x_hypertension +
  theme_bw()+
  theme(
    plot.title = element_text(size = 19, hjust = 0.5),
    axis.title = element_text(size = 17),
    axis.text.y = element_text(size = 15),
    axis.text.x = element_text(size = 15)
  )
```

По мере увеличения степени гипертензии возраст пациентов в среднем увеличивается, что указывает на возможную ассоциацию выраженности гипертензии от возраста.

Рассмотрим данный график в зависимости от пола.

```{r, fig.width=12, fig.height=6}
scale_fill_gender <- scale_fill_manual(
    name = "Пол",
    labels = c(
      "Male" = "Мужской",
      "Female" = "Женский"),
    values = c(
      "Male" = "dodgerblue",
      "Female" = "palevioletred"))

ggplot(hypertension, aes(x = severity_hypertension, y = Age, fill = Gender)) +
  geom_boxplot(position = position_dodge(width = 0.8)) +
  labs(title = "Распределение возраста пациентов в зависимости от выраженности гипертензии", 
       x = "Группа", 
       y = "Возраст, лет")+
  scale_x_hypertension+
  scale_fill_gender+
  theme_bw()+
  theme(
    plot.title = element_text(size = 21, hjust = 0.2),
    axis.title = element_text(size = 18),
    axis.text.y = element_text(size = 16),
    axis.text.x = element_text(size = 16),
    legend.position = "inside",
    legend.justification = c("right", "top"),
    legend.title = element_text(size = 18),
    legend.text = element_text(size = 18),
    legend.background = element_rect(color = "black", size = 0.3)
  )
```
Видно, что средний возраст женщин в каждой из групп меньше, чем у мужчин.

## Распределение пола по группам в зависимости от выраженности гипертензии

Построим график распределения пола пациентов в зависимости от выраженности гипертензии в группах.

```{r, fig.width=14, fig.height=7}
ggplot(hypertension, aes(x = severity_hypertension, fill = Gender)) +
  geom_bar(position = "dodge", width = 0.7) +
  labs(title = "График распределения пола пациентов по группам в зависимости от выраженности гипертензии", 
       x = "Группа", 
       y = "Количество пациентов") +
  scale_x_hypertension +
  scale_y_continuous(
    name = "Количество пациентов",
    breaks = seq(0, 150, 25))+
  scale_fill_gender+
  theme_bw()+
  theme(
    plot.title = element_text(size = 21, hjust = 0.5),
    axis.title = element_text(size = 19),
    axis.text.y = element_text(size = 16),
    axis.text.x = element_text(size = 18),
    legend.position = "inside",
    legend.justification = c("right", "top"),
    legend.title = element_text(size = 19),
    legend.text = element_text(size = 19),
    legend.background = element_rect(color = "black", size = 0.3)
  )
```

Из графика видно, что женщин больше в каждой из групп. Также видно, что количество пациентов в каждой из групп снижается с повышением степени гипертензии.

## Распределение групп по деревням в зависимости от выраженности гипертензии 

Построим график распределения групп по деревням. 

```{r, fig.width=14, fig.height=7}
scale_fill_hypertension <- scale_fill_manual(
    name = "Группа",
    labels = c(
      "norm" = "Здоровые пациенты",
      "stage1" = "1 степень",
      "stage2" = "2 степень",
      "stage3" = "3 степень"),
    values = c(
      "norm" = "palegreen",
      "stage1" = "seagreen2",
      "stage2" = "mediumseagreen",
      "stage3" = "seagreen"))

ggplot(hypertension, aes(x = Village, fill = severity_hypertension)) +
  geom_bar(position = "dodge", width = 0.8) +
  labs(title = "График распределения групп по деревням в зависимости от выраженности гипертензии",
       x = "Деревня", y = "Количество пациентов")+
  scale_fill_hypertension+
  theme_bw()+
  theme(
    plot.title = element_text(size = 23, hjust = 0.5),
    axis.title = element_text(size = 20),
    axis.text.y = element_text(size = 16),
    axis.text.x = element_text(size = 16),
    legend.position = "inside",
    legend.justification = c("right", "top"),
    legend.title = element_text(size = 18),
    legend.text = element_text(size = 18),
    legend.background = element_rect(color = "black", size = 0.3)
  )
```
Видно, что в двух деревнях (Bare' Nuevo и Batey Verde) не было пациентов с гипертензией 3 степени. Во всех деревнях большинство пациентов здоровы.

## Систолическое и диастолическое давление по группам в зависимости от выраженности гипертензии
```{r, fig.width=14, fig.height=9}
ggplot(hypertension, aes(x = severity_hypertension, y = SBP)) +
  geom_violin(fill = "cornflowerblue", alpha = 0.5) +
  geom_boxplot(fill = "royalblue4", width = 0.15) +
  labs(title = "САД по группам в зависимости от выраженности гипертензии", 
       x = "Группа", 
       y = "САД, мм рт. ст.") +
  scale_x_hypertension+
  scale_y_continuous(
    name = "САД, мм рт. ст.",
    breaks = seq(0, 300, 25))+
  theme_bw()+
  theme(
    plot.title = element_text(size = 28, hjust = 0.5),
    axis.title = element_text(size = 25),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_text(size = 19)
  )

ggplot(hypertension, aes(x = severity_hypertension, y = DBP, fill = severity_hypertension)) +
  geom_violin(fill = "cornflowerblue", alpha = 0.5) +
  geom_boxplot(fill = "royalblue4", width = 0.15) +
  labs(title = "ДАД по группам в зависимости от выраженности гипертензии", 
       x = "Группа", 
       y = "ДАД, мм рт. ст.") +
  scale_y_continuous(
    name = "САД, мм рт. ст.",
    breaks = seq(0, 300, 25))+
  scale_x_hypertension+
  theme_bw()+
  theme(
    plot.title = element_text(size = 28, hjust = 0.5),
    axis.title = element_text(size = 25),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_text(size = 19)
  )
```

САД и ДАД увеличиваются с возрастанием степени гипертензии, что логично и соответствует классификации артериальной гипертензии, а также видно, что диапазон значений и медиана для ДАД и САД четко различаются между группами в зависимости от выраженности гипертензии.

# 4. Выбор и реализация методов однофакторного анализа для количественной оценки взаимосвязи между степенью гипертензии и собранными признаками пациентов.

## Сравнение тяжести гипертензии у мужчин и женщин (тест Манна-уитни)

Вопрос исследования: Отличаются ли превосходят ли как правило тяжесть гипертензии у представителей одного пола относительно другого?

\$H_0\$: *Медианы тяжести гипертензии у мужчин и женщин равны*

\$H_a\$: *Медианы тяжести гипертензии у мужчин и женщин не равны*

```{r  hypertension_gender_wilcox_test}
hypertension_gender_MWtest <- wilcox.exact(SBP ~ Gender,
                                data = hypertension, 
                                alternative = "two.sided", 
                                conf.int = TRUE, 
                                conf.level = 0.95)

print(hypertension_gender_MWtest)
```
*p-значение  = 0.2998 показывает, что на уровне значимости α = 0.05 нулевая гипотеза не может быть отвергнута.* Аналогичные вычисления, но с сырыми значениями давления также не позволили отвергнуть нулевую гипотезу и найти ассоциацию между тяжестью гипертензии и полом. Тест Манна–Уитни показал, что распределение тяжести гипертензии не отличается между мужчинами и женщинами (W = 15972, p = 0.92), что указывает на отсутствие статистически значимого доминирования одной группы над другой


## Сравнение тяжести гипертензии у в зависимости от возраста (коэффициент корреляции Спирмена)

\$H_0\$: *Возраст не ассоциирован с тяжестью гипертензии*

\$H_a\$: *Возраст ассоциирован с тяжестью гипертензии*

```{r hypertension_age_test}

hypertension_age_SPtest <- cor.test(hypertension$Age, hypertension$Severity_hypertension_category, method = "spearman")

print(hypertension_age_SPtest)
```
*Существует слабая, но статистически значимая положительная зависимость: возраст ассоциирован с тяжестью гипертензии.*

## Сравнение тяжести гипертензии в зависимости от возраста в зависимости от пола (коэффициент корреляции Спирмена)

\$H_0\$: *Нет ранговой ассоциации между возрастом и тяжестью внутри данной группы*

\$H_a\$: *Ранговой ассоциации между возрастом и тяжестью внутри данной группы*

```{r gender_hyp}
get_village_statistics <- function(df, gender) {
  df <- df %>%
    filter(Gender == gender) 
  test_result <- cor.test(df$Age, df$Severity_hypertension_category, method = "spearman") 
  interval_result <- SpearmanRho(df$Age, df$Severity_hypertension_category, conf.level = 0.95) 
  return(c(gender = gender, 
           rho = round(test_result$estimate, 2), 
           p.val = round(test_result$p.value, 4), 
           interval = round(interval_result, 2)))
}

genders <- levels(factor(hypertension$Gender))
reses_gender <-list()
for (i in seq_along(genders)) {
  g <- genders[i]
  reses_gender[[i]] <- get_village_statistics(hypertension, g)
}
print(reses_gender)

```
*У женщин выявлена статистически значимая положительная связь между возрастом и тяжестью гипертензии (ρ = 0.40, p < 0.0001), тогда как у мужчин такой зависимости не отмечено. Различие доверительных интервалов предполагает возможный модифицирующий эффект пола.* 

## Проверка зависимости гипертензии от возраста женщин для каждой деревни 

```{r village_female_hyp}
get_village_statistics <- function(df, village) {
  df <- df %>%
    filter(Village == village, Gender == "Female") 
  test_result <- cor.test(df$Age, df$Severity_hypertension_category, method = "spearman") 
  return(test_result)
}

villages <- levels(factor(hypertension$Village))
reses_villages <-list()
for (i in seq_along(villages)) {
  v <- villages[i]
  stat_villages <- get_village_statistics(hypertension, v)
  reses_villages[[i]] <- c(village=v,
                           rho = round(stat_villages$estimate, 2),
                           p.val = round(stat_villages$p.value, 4))
} 
print(reses_villages)

```
*При расммотрении каждой деревни по отдельности можно найти деревни, где наблюдается сильная или средняя статистически значимые ассоциации между возрастом женщин и тяжестью гипертензии. В Bare' Nuevo ρ = 0.74, p = 0.0003, в San Antonio  ρ = 0.59, p = 0.0063, в Batey Verde ρ = 0.51, p = 0.0038, в Juan Sanchez ρ = 0.42, p = 0.0071, в Carmona ρ = 0.38, p = 0.0172, в Cojobal p = 0.32, p = 0.0279. В деревнях La Altagracia и Los Gueneos ассоциация статистически незначима при α = 0.05.*

## Сравнение тяжести гипертензии у в зависимости от возраста женщин (менопауза / нет менопаузы) (тест Манна-уитни)

\$H_0\$: *Тяжесть гипертензии у женщин с менопаузой ≤ тяжести у женщин до менопаузы*

\$H_a\$: *Тяжесть гипертензии у женщин с менопаузой > тяжести у женщин до менопаузы*

```{r hypertension_gender_test }
menopause_hypertension <- hypertension %>%
  select(Age, Gender, Severity_hypertension_category) %>%
  filter(Gender == "Female")  %>%
  mutate(Menopause = case_when(
    (Age < 50) ~ "no",
    (Age >= 50) ~ "menopause"
  )) %>% 
  mutate(Menopause_category = case_when(
    (Menopause == "no") ~ 0,
    (Menopause == "menopause") ~ 1
  ))

hypertension_menopause_MWtest <- wilcox.exact(Severity_hypertension_category ~ Menopause_category,
                                data = menopause_hypertension, 
                                alternative = "less", 
                                conf.int = TRUE, 
                                conf.level = 0.95)

print(hypertension_gender_MWtest)
```

## Сравнение тяжести гипертензии в зависимости от деревни 

\$H_0\$: *Связи между деревней и тяжестью гпертензии нет*

\$H_a\$: *Связь между деревней и тяжестью гпертензии есть*

```{r contingency table }

cont_table_village_hyp <- table(hypertension$Village, hypertension$severity_hypertension)
chisq.test(cont_table_village_hyp)
```
*Значение p-value = 0.6558 показывает, что нельзя отвергнуть нулевую гипотезу*

# 5. Интерпретация полученных результатов.

В данном исследовании была проанализирована зависимость тяжести гипертензии от трёх факторов: пола, возраста и происхождения (деревни).

Также была выявлена сильная или средняя статистически значимая взаимосвязь между степенью заболевания и происхождением у женщин в большинстве деревень.

Обнаружена слабая, но статистически значимая корреляция между возрастом пациента и степенью гипертензии. Одним из возможных факторов является снижение эластичности сосудов с возрастом, что приводит к росту артериального давления. Поскольку распределение степени тяжести заболевания в наших данных зависит от пола, все пациенты были разделены на две подгруппы.

У мужчин степень гипертензии не зависит от возраста (корреляция отсутствует), хотя, согласно литературным данным, гипертензия чаще встречается у мужчин до 50 лет. Средний возраст мужчин в нашей выборке составляет 53 года, что, возможно, смещает результаты теста.

У женщин выявлена положительная корреляция между возрастом и степенью заболевания, что, вероятно, связано с изменением уровня эстрогенов до и после наступления менопаузы.


